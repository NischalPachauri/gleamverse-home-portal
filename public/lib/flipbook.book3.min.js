/**
 * FLIPBOOK Book3 Module - Complete Polyfill
 * This module provides 3D book rendering capabilities for the flipbook library
 */

(function (FLIPBOOK) {
    'use strict';
    console.log("Book3: Script executing. FLIPBOOK object:", FLIPBOOK);

    if (!FLIPBOOK) {
        console.error("Book3: FLIPBOOK is undefined! Creating it globally.");
        FLIPBOOK = window.FLIPBOOK = window.FLIPBOOK || {};
    }

    // Book3 class for 3D rendering
    FLIPBOOK.Book3 = function (main, gl, options) {
        console.log('Book3: Constructor called with:', main, gl, options);
        this.main = main;
        this.gl = gl;
        this.options = options || {};

        // Handle different constructor signatures
        if (arguments.length === 1 && main && !gl && !options) {
            console.log('Book3: Detected single argument constructor');
            this.options = main;
            this.main = null;
        }

        this.pages = [];
        this.currentPage = 0;
        this.visiblePages = [];
        this.zoomLevel = 1;

        // Improved container detection
        this.container = this.options.container ||
            (this.main ? (this.main.container || this.main.wrapper || this.main.el || this.main.$el || (this.main.options ? this.main.options.container : null)) : null);

        if (!this.container) {
            console.warn('Book3: Container not found in options or main instance', this.main);
        } else {
            console.log('Book3: Container found', this.container);
        }

        this.prevEnabled = true;
        this.nextEnabled = true;
    };

    FLIPBOOK.Book3.prototype = {
        init: function () {
            console.log('Book3: Initializing 3D book renderer');
            return this;
        },

        loadPages: function (pages) {
            this.pages = pages || [];
            console.log('Book3: Loaded', this.pages.length, 'pages');
            this.updateVisiblePages();
            return this;
        },

        updateVisiblePages: function () {
            const currentIndex = this.currentPage;
            this.visiblePages = [];

            if (currentIndex > 0) {
                this.visiblePages.push(currentIndex - 1);
            }
            this.visiblePages.push(currentIndex);
            if (currentIndex < this.pages.length - 1) {
                this.visiblePages.push(currentIndex + 1);
            }

            console.log('Book3: Visible pages updated:', this.visiblePages);
            return this;
        },

        goToPage: function (pageNumber) {
            this.currentPage = Math.max(0, Math.min(pageNumber, this.pages.length - 1));
            console.log('Book3: Going to page', this.currentPage);
            this.updateVisiblePages();

            // If page is not loaded, request it
            if (!this.pages[this.currentPage]) {
                console.log('Book3: Page', this.currentPage, 'not loaded, requesting...');
                var pdfService = (this.main && this.main.pdfService) || FLIPBOOK.currentPdfService;
                if (pdfService && pdfService.renderBookPage) {
                    var self = this;
                    var height = (this.container && this.container.clientHeight) ? this.container.clientHeight : 1000;
                    pdfService.renderBookPage(this.currentPage, height, function (data) {
                        if (data && data.canvas) {
                            console.log('Book3: Received page', self.currentPage, 'from goToPage request');
                            self.setPageTexture(self.currentPage, data.canvas);
                        }
                    });
                }
            } else {
                this.render();
            }
            return this;
        },

        nextPage: function () {
            if (this.currentPage < this.pages.length - 1) {
                this.currentPage++;
                this.updateVisiblePages();
                this.render();
            }
            return this;
        },

        prevPage: function () {
            if (this.currentPage > 0) {
                this.currentPage--;
                this.updateVisiblePages();
                this.render();
            }
            return this;
        },

        enablePrev: function (val) {
            this.prevEnabled = val;
            return this;
        },

        enableNext: function (val) {
            this.nextEnabled = val;
            return this;
        },

        isPrevEnabled: function () {
            return this.prevEnabled;
        },

        isNextEnabled: function () {
            return this.nextEnabled;
        },

        getCurrentPage: function () {
            return this.currentPage;
        },

        getTotalPages: function () {
            return this.pages.length;
        },

        resize: function (width, height) {
            console.log('Book3: Resizing to', width, 'x', height);
            this.render();
            return this;
        },

        enable: function () {
            return this;
        },

        disable: function () {
            return this;
        },

        zoomTo: function (scale, x, y, duration) {
            this.zoomLevel = scale || 1;
            this.render();
            return this;
        },

        zoomIn: function (x, y) {
            this.zoomLevel = (this.zoomLevel || 1) * 1.2;
            this.render();
            return this;
        },

        zoomOut: function (x, y) {
            this.zoomLevel = (this.zoomLevel || 1) / 1.2;
            this.render();
            return this;
        },

        resetZoom: function () {
            this.zoomLevel = 1;
            this.render();
            return this;
        },

        getZoom: function () {
            return this.zoomLevel || 1;
        },

        showPage: function (pageIndex) {
            return this;
        },

        hidePage: function (pageIndex) {
            return this;
        },

        setPageTexture: function (pageIndex, texture) {
            console.log('Book3: Setting texture for page', pageIndex);
            this.pages[pageIndex] = texture;

            if (pageIndex === this.currentPage) {
                this.render();
            }
            return this;
        },

        dispose: function () {
            console.log('Book3: Disposing resources');
            this.pages = [];
            this.visiblePages = [];
            if (this.container) {
                this.container.innerHTML = '';
            }
            return this;
        },

        render: function () {
            console.log('Book3: Rendering page', this.currentPage);

            if (!this.container) {
                console.error('Book3: No container available for rendering');
                return this;
            }

            this.container.innerHTML = '';

            var wrapper = document.createElement('div');
            wrapper.style.width = '100%';
            wrapper.style.height = '100%';
            wrapper.style.display = 'flex';
            wrapper.style.justifyContent = 'center';
            wrapper.style.alignItems = 'center';
            wrapper.style.overflow = 'hidden';

            var pageTexture = this.pages[this.currentPage];
            if (pageTexture) {
                if (pageTexture instanceof HTMLImageElement || pageTexture instanceof HTMLCanvasElement) {
                    pageTexture.style.transform = 'scale(' + this.zoomLevel + ')';
                    pageTexture.style.transition = 'transform 0.2s ease';
                    pageTexture.style.maxWidth = '100%';
                    pageTexture.style.maxHeight = '100%';
                    pageTexture.style.objectFit = 'contain';
                    wrapper.appendChild(pageTexture);
                } else {
                    console.warn('Book3: Page texture is not an element', pageTexture);
                }
            } else {
                console.log('Book3: Page not loaded yet', this.currentPage);
                var loading = document.createElement('div');
                loading.textContent = 'Loading page ' + (this.currentPage + 1) + '...';
                wrapper.appendChild(loading);

                var pdfService = (this.main && this.main.pdfService) || FLIPBOOK.currentPdfService;

                if (pdfService && pdfService.renderBookPage) {
                    console.log('Book3: Requesting page render from PdfService fallback for page', this.currentPage);
                    var self = this;
                    var height = (this.container && this.container.clientHeight) ? this.container.clientHeight : 1000;

                    pdfService.renderBookPage(this.currentPage, height, function (data) {
                        console.log('Book3: Fallback callback received data', data);
                        if (data && data.canvas) {
                            console.log('Book3: Received page from fallback', self.currentPage);
                            self.setPageTexture(self.currentPage, data.canvas);
                        }
                    });
                }
            }

            this.container.appendChild(wrapper);
            return this;
        }
    };

    console.log("Book3: FLIPBOOK.Book3 defined successfully", FLIPBOOK.Book3);

})(window.FLIPBOOK || (window.FLIPBOOK = {}));
