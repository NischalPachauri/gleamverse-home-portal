/**
 * Gleamverse Flipbook Viewer (refactored)
 * Provides a robust PDF flipbook with smooth animations, responsive scaling,
 * error handling, and a jQuery-compatible API.
 */

var FLIPBOOK = window.FLIPBOOK || {};
(function ($, window, document) {
  if (!$ || typeof document === 'undefined') {
    return;
  }

  var DEFAULTS = {
    pdfUrl: null,
    startPage: 0,
    rightToLeft: false,
    layout: '2',
    pdfPageScale: 1,
    htmlLayer: false,
    sound: false,
    loadPagesF: 2,
    loadPagesB: 1,
    backgroundTransparent: true,
    pdfOutline: true,
    autoplayOnStart: false,
    autoplayInterval: 3000,
    autoplayLoop: true,
    assets: {
      spinner: '/images/spinner.gif'
    }
  };

  function ensurePdfJs() {
    return new Promise(function (resolve, reject) {
      if (window.pdfjsLib && window.pdfjsLib.getDocument) return resolve();
      var s = document.createElement('script');
      s.src = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.97/pdf.min.js';
      s.async = true;
      s.onload = function () {
        try {
          window.pdfjsLib = window['pdfjs-dist/build/pdf'];
          if (window.pdfjsLib) resolve(); else reject(new Error('pdfjsLib missing'));
        } catch (e) { reject(e); }
      };
      s.onerror = function () { reject(new Error('Failed to load PDF.js')); };
      document.head.appendChild(s);
    });
  }

  function clamp(n, min, max) { return Math.max(min, Math.min(max, n)); }

  function Flipbook($el, options) {
    this.$el = $el;
    this.opts = $.extend({}, DEFAULTS, options || {});
    this.state = {
      doc: null,
      pageCount: 0,
      current: 0,
      zoom: 1,
      pageSize: { w: 0, h: 0 },
      animating: false,
      destroyed: false,
      outline: null
    };
    this.api = null;
    this.init();
  }

  Flipbook.prototype._error = function (msg) {
    try {
      this.$el.trigger('flipbookError', msg);
    } catch (e) {}
  };

  Flipbook.prototype._renderSpinner = function () {
    var div = document.createElement('div');
    div.className = 'cssload-container';
    var wheel = document.createElement('div');
    wheel.className = 'cssload-speeding-wheel';
    div.appendChild(wheel);
    try {
      var host = this.$el && this.$el[0] ? this.$el[0] : null;
      if (host) host.appendChild(div);
    } catch (e) {}
  };

  Flipbook.prototype._setLoading = function (container, on) {
    if (!container) return;
    var id = 'flipbook-pre-' + (container.__preid || Date.now());
    container.__preid = id;
    if (on) {
      var pre = document.createElement('div');
      pre.className = 'flipbook-page-preloader';
      var img = document.createElement('div');
      img.className = 'cssload-speeding-wheel';
      pre.appendChild(img);
      pre.setAttribute('data-pre', id);
      container.appendChild(pre);
    } else {
      var el = container.querySelector('[data-pre="' + id + '"]');
      if (el && el.parentNode) el.parentNode.removeChild(el);
    }
  };

  Flipbook.prototype.init = function () {
    var self = this;
    if (!self.$el || !self.$el.length) {
      self._error('Container missing');
      return;
    }
    if (!self.opts || !self.opts.pdfUrl) {
      self._error('pdfUrl is required');
      return;
    }
    self._renderSpinner();
    ensurePdfJs().then(function () {
      if (self.state.destroyed) return;
      try {
        var g = window.pdfjsLib && window.pdfjsLib.GlobalWorkerOptions;
        if (g && !g.workerSrc) {
          g.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.97/pdf.worker.min.js';
        }
      } catch (e) {}
      return window.pdfjsLib.getDocument(self.opts.pdfUrl).promise;
    }).then(function (doc) {
      self.state.doc = doc;
      self.state.pageCount = doc.numPages || 0;
      try { self.$el.trigger('flipbookReady', [self.state.pageCount]); } catch (e) {}
      var start = clamp((self.opts.startPage|0), 0, Math.max(0, self.state.pageCount - 1));
      self.state.current = start;
      return doc.getPage(1);
    }).then(function (page1) {
      var viewport = page1.getViewport({ scale: self.opts.pdfPageScale });
      self.state.pageSize = { w: viewport.width, h: viewport.height };
      self._buildDom();
      self._attachEvents();
      self._renderSpread(self.state.current);
      if (self.opts.pdfOutline) self._loadOutline();
    }).catch(function (err) {
      self._error(err && err.message ? err.message : 'Initialization failed');
      try { self.$el.text('Failed to initialize flipbook'); } catch {}
    });
  };

  Flipbook.prototype._buildDom = function () {
    var root = document.createElement('div');
    root.className = 'flipbook-main-wrapper flipbook-bg-light';
    var bookLayer = document.createElement('div');
    bookLayer.className = 'flipbook-bookLayer';
    var book = document.createElement('div');
    book.className = 'flipbook-book3';
    var center = document.createElement('div');
    center.className = 'flipbook-center-container3';
    var leftPage = document.createElement('div');
    leftPage.className = 'flipbook-page3 flipbook-page3-front';
    var rightPage = document.createElement('div');
    rightPage.className = 'flipbook-page3 flipbook-page3-back';
    var overlay = document.createElement('div');
    overlay.className = 'flipbook-page3-shadow';
    overlay.style.opacity = '0';
    center.appendChild(leftPage);
    center.appendChild(rightPage);
    center.appendChild(overlay);
    book.appendChild(center);
    bookLayer.appendChild(book);
    root.appendChild(bookLayer);
    try {
      var host = this.$el && this.$el[0] ? this.$el[0] : null;
      if (host) {
        var old = host.querySelector('.flipbook-main-wrapper');
        if (old && old.parentNode) old.parentNode.removeChild(old);
        var pre = host.querySelector('.cssload-container');
        if (pre && pre.parentNode) pre.parentNode.removeChild(pre);
        host.appendChild(root);
      }
    } catch (e) {}
    this.dom = { root: root, center: center, left: leftPage, right: rightPage, overlay: overlay };
    this._resize();
  };

  Flipbook.prototype._attachEvents = function () {
    var self = this;
    function onResize() { self._resize(); }
    window.addEventListener('resize', onResize);
    self._onResize = onResize;
  };

  Flipbook.prototype._resize = function () {
    var box = this.$el[0].getBoundingClientRect();
    var pw = this.state.pageSize.w, ph = this.state.pageSize.h;
    if (!pw || !ph) return;
    var aspect = pw / ph;
    var availableW = box.width;
    var availableH = box.height;
    var columns = (this.opts.layout === '2') ? 2 : 1;
    var targetW = availableW;
    var targetH = availableH;
    var singleW = targetW / columns;
    var singleH = singleW / aspect;
    if (singleH > targetH) {
      singleH = targetH;
      singleW = singleH * aspect;
    }
    this.dom.left.style.width = singleW + 'px';
    this.dom.left.style.height = singleH + 'px';
    this.dom.left.style.left = '0px';
    this.dom.left.style.top = '0px';
    this.dom.right.style.width = singleW + 'px';
    this.dom.right.style.height = singleH + 'px';
    this.dom.right.style.left = (columns === 2 ? singleW : 0) + 'px';
    this.dom.right.style.top = '0px';
    this.dom.center.style.width = (columns * singleW) + 'px';
    this.dom.center.style.height = singleH + 'px';
  };

  Flipbook.prototype._renderPageInto = function (pageIndex, container) {
    var self = this;
    container.innerHTML = '';
    if (!self.state.doc) return;
    var n = pageIndex + 1;
    if (n < 1 || n > self.state.pageCount) {
      var blank = document.createElement('div');
      blank.className = 'flipbook-page3-bg';
      blank.style.background = '#f1f1f1';
      container.appendChild(blank);
      return;
    }
    self._setLoading(container, true);
    var timedOut = false;
    var timer = setTimeout(function () {
      timedOut = true;
      self._error('Page load timeout for ' + n);
      self._setLoading(container, false);
    }, 7000);
    self.state.doc.getPage(n).then(function (page) {
      var vw = page.getViewport({ scale: self.opts.pdfPageScale * self.state.zoom });
      var canvas = document.createElement('canvas');
      var ctx = canvas.getContext('2d', { alpha: false });
      canvas.width = Math.floor(vw.width);
      canvas.height = Math.floor(vw.height);
      var renderCtx = { canvasContext: ctx, viewport: vw }; 
      page.render(renderCtx).promise.then(function () {
        var wrapper = document.createElement('div');
        wrapper.className = 'flipbook-page3-inner';
        wrapper.style.width = '100%';
        wrapper.style.height = '100%';
        wrapper.appendChild(canvas);
        container.appendChild(wrapper);
        var cw = container.clientWidth || vw.width;
        var ch = container.clientHeight || vw.height;
        var sx = cw / vw.width; var sy = ch / vw.height; var s = Math.min(sx, sy);
        canvas.style.transformOrigin = '0 0';
        canvas.style.transform = 'scale(' + s + ')';
        if (!timedOut) {
          clearTimeout(timer);
          self._setLoading(container, false);
        }
      }).catch(function (e) {
        self._error('Render failed: ' + (e && e.message || ''));
        self._setLoading(container, false);
      });
    }).catch(function (e) {
      self._error('Page load failed: ' + (e && e.message || ''));
      self._setLoading(container, false);
    });
  };

  Flipbook.prototype._renderSpread = function (leftIndex) {
    var self = this;
    var rightIndex = (self.opts.layout === '2') ? leftIndex + 1 : leftIndex;
    self._renderPageInto(leftIndex, self.dom.left);
    self._renderPageInto(rightIndex, self.dom.right);
    try { self.$el.trigger('pageChange', [leftIndex]); } catch (e) {}
  };

  Flipbook.prototype.nextPage = function () {
    var self = this;
    if (self.state.animating) return;
    var step = (self.opts.layout === '2' ? 2 : 1);
    var maxLeft = Math.max(0, self.state.pageCount - step);
    var next = clamp(self.state.current + step, 0, maxLeft);
    if (next === self.state.current) return;
    self._flip('forward', next);
  };

  Flipbook.prototype.prevPage = function () {
    var self = this;
    if (self.state.animating) return;
    var step = (self.opts.layout === '2' ? 2 : 1);
    var prev = clamp(self.state.current - step, 0, Math.max(0, self.state.pageCount - step));
    if (prev === self.state.current) return;
    self._flip('backward', prev);
  };

  Flipbook.prototype.goToPage = function (pageZeroBased) {
    var self = this;
    var step = (self.opts.layout === '2') ? 2 : 1;
    var even = Math.floor(pageZeroBased / step) * step;
    even = clamp(even, 0, Math.max(0, self.state.pageCount - step));
    self._flip(even > self.state.current ? 'forward' : 'backward', even);
  };

  Flipbook.prototype._flip = function (dir, targetLeft) {
    var self = this;
    if (self.state.animating) return;
    self.state.animating = true;
    try {
      var klass = dir === 'forward' ? 'flipbook-turn-forward' : 'flipbook-turn-backward';
      self.dom.overlay.style.opacity = '0.18';
      var target = dir === 'forward' ? self.dom.right : self.dom.left;
      target.classList.add(klass);
      setTimeout(function () {
        try { target.classList.remove(klass); } catch (e) {}
        self.dom.overlay.style.opacity = '0';
        self.state.current = targetLeft;
        self._renderSpread(self.state.current);
        self.state.animating = false;
      }, 300);
    } catch (e) {
      self.state.current = targetLeft;
      self._renderSpread(self.state.current);
      self.state.animating = false;
    }
  };

  Flipbook.prototype.zoomIn = function () {
    this.state.zoom = clamp(this.state.zoom + 0.1, 0.5, 3.0);
    this._renderSpread(this.state.current);
  };

  Flipbook.prototype.zoomOut = function () {
    this.state.zoom = clamp(this.state.zoom - 0.1, 0.5, 3.0);
    this._renderSpread(this.state.current);
  };

  Flipbook.prototype._loadOutline = function () {
    var self = this;
    if (!self.state.doc || !self.state.doc.getOutline) return;
    self.state.doc.getOutline().then(function (outline) {
      self.state.outline = outline || [];
      try { self.$el.trigger('outlineLoaded', [self.state.outline]); } catch (e) {}
    }).catch(function () {});
  };

  Flipbook.prototype.destroy = function () {
    this.state.destroyed = true;
    try { window.removeEventListener('resize', this._onResize); } catch (e) {}
    try { this.$el.off('pageChange'); } catch (e) {}
    try {
      var host = this.$el && this.$el[0] ? this.$el[0] : null;
      var old = host ? host.querySelector('.flipbook-main-wrapper') : null;
      if (old && old.parentNode) old.parentNode.removeChild(old);
    } catch (e) {}
  };

  FLIPBOOK.Main = function (options, jqEl) {
    var $el = $(jqEl);
    var inst = new Flipbook($el, options);
    var api = {
      nextPage: function () { inst.nextPage(); },
      prevPage: function () { inst.prevPage(); },
      goToPage: function (p) { inst.goToPage(p|0); },
      zoomIn: function () { inst.zoomIn(); },
      zoomOut: function () { inst.zoomOut(); },
      getCurrentPage: function () { return inst.state.current; },
      getPageCount: function () { return inst.state.pageCount; },
      destroy: function () { inst.destroy(); }
    };
    inst.api = api;
    return api;
  };

  $.fn.flipBook = function (opts) {
    return new FLIPBOOK.Main(opts || {}, this);
  };
  $.fn.swipeBook = function (opts) {
    var o = $.extend({}, opts || {}, { viewMode: 'swipe' });
    return new FLIPBOOK.Main(o, this);
  };

  $.fn.flipBook.options = DEFAULTS;

})(window.jQuery || window.$, window, document);
